# GitLab CI/CD Pipeline para QA
stages:
  - prepare
  - test
  - quality
  - security
  - deploy

variables:
  NODE_VERSION: "18"
  DOCKER_DRIVER: overlay2
  FF_USE_FASTZIP: "true"

default:
  image: node:${NODE_VERSION}-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/

# ===================
# PREPARE STAGE
# ===================
install:
  stage: prepare
  script:
    - npm ci --cache .npm --prefer-offline
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ===================
# TEST STAGE
# ===================
lint:
  stage: test
  needs: [install]
  script:
    - npm run lint -- --format gitlab > gl-codequality.json || true
  artifacts:
    reports:
      codequality: gl-codequality.json

unit-tests:
  stage: test
  needs: [install]
  script:
    - npm run test:unit -- --coverage --reporters=default --reporters=jest-junit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - coverage/
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

integration-tests:
  stage: test
  needs: [install]
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    POSTGRES_DB: testdb
    DATABASE_URL: postgresql://test:test@postgres:5432/testdb
    REDIS_URL: redis://redis:6379
  script:
    - npm run test:integration

e2e-tests:
  stage: test
  needs: [install]
  image: cypress/browsers:node18.12.0-chrome107
  parallel:
    matrix:
      - BROWSER: [chrome, firefox]
  script:
    - npm start &
    - npx wait-on http://localhost:3000
    - npm run test:e2e -- --browser ${BROWSER}
  artifacts:
    when: always
    paths:
      - cypress/videos/
      - cypress/screenshots/
    expire_in: 1 week

# ===================
# QUALITY STAGE
# ===================
quality-gate:
  stage: quality
  needs: [unit-tests, integration-tests, e2e-tests]
  script:
    - |
      COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
      echo "Coverage: $COVERAGE%"
      if [ $(echo "$COVERAGE < 80" | bc) -eq 1 ]; then
        echo "❌ Quality Gate Failed"
        exit 1
      fi
      echo "✅ Quality Gate Passed"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"

sonarqube:
  stage: quality
  needs: [unit-tests]
  image: sonarsource/sonar-scanner-cli
  script:
    - sonar-scanner
      -Dsonar.projectKey=${CI_PROJECT_NAME}
      -Dsonar.sources=src
      -Dsonar.host.url=${SONAR_HOST_URL}
      -Dsonar.token=${SONAR_TOKEN}
      -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
  allow_failure: true

# ===================
# SECURITY STAGE
# ===================
sast:
  stage: security
  needs: [install]

dast:
  stage: security
  needs: [quality-gate]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ===================
# DEPLOY STAGE
# ===================
deploy-staging:
  stage: deploy
  needs: [quality-gate]
  environment:
    name: staging
    url: https://staging.example.com
  script:
    - echo "Deploying to staging..."
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy-production:
  stage: deploy
  needs: [quality-gate, sast]
  environment:
    name: production
    url: https://example.com
  script:
    - echo "Deploying to production..."
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
