# Azure DevOps Pipeline para QA
trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/*'

pr:
  branches:
    include:
      - main

variables:
  - group: qa-variables
  - name: nodeVersion
    value: '18.x'
  - name: vmImage
    value: 'ubuntu-latest'

stages:
  # ===================
  # BUILD STAGE
  # ===================
  - stage: Build
    displayName: 'ðŸ“¦ Build & Lint'
    jobs:
      - job: Build
        pool:
          vmImage: $(vmImage)
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(nodeVersion)
          
          - task: Cache@2
            displayName: 'Cache npm'
            inputs:
              key: 'npm | $(Agent.OS) | package-lock.json'
              path: $(npm_config_cache)
          
          - script: npm ci
            displayName: 'Install dependencies'
          
          - script: npm run lint
            displayName: 'Run ESLint'
          
          - script: npm run build
            displayName: 'Build project'
          
          - publish: $(System.DefaultWorkingDirectory)
            artifact: build
            displayName: 'Publish build'

  # ===================
  # TEST STAGE
  # ===================
  - stage: Test
    displayName: 'ðŸ§ª Test Suite'
    dependsOn: Build
    jobs:
      - job: UnitTests
        displayName: 'Unit Tests'
        pool:
          vmImage: $(vmImage)
        steps:
          - download: current
            artifact: build
          
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
          
          - script: npm run test:unit -- --coverage --ci
            displayName: 'Run unit tests'
            workingDirectory: $(Pipeline.Workspace)/build
          
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              mergeTestResults: true
          
          - task: PublishCodeCoverageResults@1
            displayName: 'Publish coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '**/cobertura-coverage.xml'

      - job: IntegrationTests
        displayName: 'Integration Tests'
        pool:
          vmImage: $(vmImage)
        services:
          postgres: postgres:15
          redis: redis:7
        steps:
          - download: current
            artifact: build
          
          - script: npm run test:integration
            displayName: 'Run integration tests'
            workingDirectory: $(Pipeline.Workspace)/build
            env:
              DATABASE_URL: $(DATABASE_URL)

      - job: E2ETests
        displayName: 'E2E Tests'
        pool:
          vmImage: $(vmImage)
        strategy:
          matrix:
            Chrome:
              browser: chrome
            Firefox:
              browser: firefox
        steps:
          - download: current
            artifact: build
          
          - script: |
              npm start &
              npx wait-on http://localhost:3000
              npm run test:e2e -- --browser $(browser)
            displayName: 'Run E2E tests'
            workingDirectory: $(Pipeline.Workspace)/build
          
          - publish: $(Pipeline.Workspace)/build/cypress/videos
            artifact: e2e-videos-$(browser)
            condition: failed()

  # ===================
  # QUALITY GATE
  # ===================
  - stage: QualityGate
    displayName: 'ðŸ“Š Quality Gate'
    dependsOn: Test
    jobs:
      - job: Gate
        pool:
          vmImage: $(vmImage)
        steps:
          - script: |
              COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
              echo "Coverage: $COVERAGE%"
              if (( $(echo "$COVERAGE < 80" | bc -l) )); then
                echo "##vso[task.complete result=Failed;]Coverage below threshold"
                exit 1
              fi
            displayName: 'Check coverage threshold'

  # ===================
  # DEPLOY STAGES
  # ===================
  - stage: DeployStaging
    displayName: 'ðŸš€ Deploy Staging'
    dependsOn: QualityGate
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployStaging
        environment: staging
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploying to staging..."

  - stage: DeployProduction
    displayName: 'ðŸŒŸ Deploy Production'
    dependsOn: QualityGate
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployProduction
        environment: production
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploying to production..."
